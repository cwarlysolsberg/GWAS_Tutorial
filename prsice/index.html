<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Background - Basic Tutorial for Genome Wide Association Analysis</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link href="../css/extra.css" rel="stylesheet" />
  <link href="../css/details.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Background";
    var mkdocs_page_input_path = "prsice.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-145068952-1', 'auto');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Basic Tutorial for Genome Wide Association Analysis</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../QC/">1. Quality Control of GWAS Data</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../popstrat/">2. Population Stratification</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../assoc/">3. Association Analyses</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../plink/">PLINK</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../plink_visual/">4. Visualizing association results</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="" href="../assocdive.md">5. Deep dive into underpinnings of associations</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../Additional_considerations/">6. Additional Considerations</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../prs/">7.PRS</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Basic Tutorial for Genome Wide Association Analysis</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Background</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/choishingwan/PRS-Tutorial/edit/master/docs/prsice.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="background">Background<a class="headerlink" href="#background" title="Permanent link">&para;</a></h1>
<p>PRSice-2 is one of the dedicated PRS programs which automates many of the steps from the previous page that used a sequence of PLINK functions (plus some QC steps). 
On this page you will run a PRS analysis using PRSice-2, which implements the standard C+T method.</p>
<h2 id="obtaining-prsice-2">Obtaining PRSice-2<a class="headerlink" href="#obtaining-prsice-2" title="Permanent link">&para;</a></h2>
<p><code>PRSice-2</code> can be downloaded from:</p>
<table>
<thead>
<tr>
<th>Operating System</th>
<th align="center">Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>Linux 64-bit</td>
<td align="center"><a href="https://github.com/choishingwan/PRSice/releases/download/2.3.3/PRSice_linux.zip">v2.3.3</a></td>
</tr>
<tr>
<td>OS X 64-bit</td>
<td align="center"><a href="https://github.com/choishingwan/PRSice/releases/download/2.3.3/PRSice_mac.zip">v2.3.3</a></td>
</tr>
</tbody>
</table>
<p>and can be directly used after extracting the file. </p>
<p>In this tutorial, you will only need <code>PRSice.R</code> and <code>PRSice_XXX</code> where XXX is the operation system</p>
<h2 id="required-data">Required Data<a class="headerlink" href="#required-data" title="Permanent link">&para;</a></h2>
<p>This analysis assumes that you have the following files (or you can download it from <a href="https://drive.google.com/file/d/1x_G0Gxk9jFMY-PMqwtg6-vdEyUPp5p5u/view?usp=sharing">here</a>): </p>
<table>
<thead>
<tr>
<th align="center">File Name</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><strong>Height.QC.gz</strong></td>
<td align="center">The post QC base data file. While PRSice-2 can automatically apply most filtering on the base file, it cannot remove duplicated SNPs</td>
</tr>
<tr>
<td align="center"><strong>EUR.QC.bed</strong></td>
<td align="center">This file contains the genotype data that passed the QC steps</td>
</tr>
<tr>
<td align="center"><strong>EUR.QC.bim</strong></td>
<td align="center">This file contains the list of SNPs that passed the QC steps</td>
</tr>
<tr>
<td align="center"><strong>EUR.QC.fam</strong></td>
<td align="center">This file contains the samples that passed the QC steps</td>
</tr>
<tr>
<td align="center"><strong>EUR.height</strong></td>
<td align="center">This file contains the phenotype data of the samples</td>
</tr>
<tr>
<td align="center"><strong>EUR.cov</strong></td>
<td align="center">This file contains the covariates of the samples</td>
</tr>
<tr>
<td align="center"><strong>EUR.eigenvec</strong></td>
<td align="center">This file contains the principal components (PCs) of the samples</td>
</tr>
</tbody>
</table>
<h2 id="running-prs-analysis">Running PRS analysis<a class="headerlink" href="#running-prs-analysis" title="Permanent link">&para;</a></h2>
<p>To run PRSice-2 we need a single covariate file, and therefore our covariate file and PCs file should be combined. This can be done with <code>R</code> as follows:</p>
<div class="tabbed-set" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">without data.table</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">covariate &lt;- read.table("EUR.cov", header=T)
pcs &lt;- read.table("EUR.eigenvec", header=F)
colnames(pcs) &lt;- c("FID","IID", paste0("PC",1:6))
cov &lt;- merge(covariate, pcs, by=c("FID", "IID"))
write.table(cov,"EUR.covariate", quote=F, row.names=F)
q()</code></pre>
</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">with data.table</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">library(data.table)
covariate &lt;- fread("EUR.cov")
pcs &lt;- fread("EUR.eigenvec", header=F)
colnames(pcs) &lt;- c("FID","IID", paste0("PC",1:6))
cov &lt;- merge(covariate, pcs)
fwrite(cov,"EUR.covariate", sep="\t")
q()</code></pre>
</div>
</div>
<p>which generates <strong>EUR.cov</strong>.</p>
<p>PRSice-2 can then be run to obtain the PRS results as follows:</p>
<div class="tabbed-set" data-tabs="2:3"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><label for="__tabbed_2_1">Linux</label><div class="tabbed-content">
<pre class="highlight"><code class="language-bash">Rscript PRSice.R \
    --prsice PRSice_linux \
    --base Height.QC.gz \
    --target EUR.QC \
    --binary-target F \
    --pheno EUR.height \
    --cov EUR.covariate \
    --base-maf MAF:0.01 \
    --base-info INFO:0.8 \
    --stat OR \
    --or \
    --out EUR</code></pre>
</div>
<input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><label for="__tabbed_2_2">OS X</label><div class="tabbed-content">
<pre class="highlight"><code class="language-bash">Rscript PRSice.R \
    --prsice PRSice_mac \
    --base Height.QC.gz \
    --target EUR.QC \
    --binary-target F \
    --pheno EUR.height \
    --cov EUR.covariate \
    --base-maf MAF:0.01 \
    --base-info INFO:0.8 \
    --stat OR \
    --or \
    --out EUR</code></pre>
</div>
<input id="__tabbed_2_3" name="__tabbed_2" type="radio" /><label for="__tabbed_2_3">Windows</label><div class="tabbed-content">
<pre class="highlight"><code class="language-bash">Rscript PRSice.R ^
    --prsice PRSice_win64.exe ^
    --base Height.QC.gz ^
    --target EUR.QC ^
    --binary-target F ^
    --pheno EUR.height ^
    --cov EUR.covariate ^
    --base-maf MAF:0.05 ^
    --base-info INFO:0.8 ^
    --stat OR ^
    --or ^
    --out EUR</code></pre>
</div>
</div>
<p>The meaning of the parameters are as follow:</p>
<table>
<thead>
<tr>
<th align="center">Paramter</th>
<th align="center">Value</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">prsice</td>
<td align="center">PRSice_xxx</td>
<td align="left">Informs <code>PRSice.R</code> that the location of the PRSice binary</td>
</tr>
<tr>
<td align="center">base</td>
<td align="center">Height.QC.gz</td>
<td align="left">Informs <code>PRSice</code> that the name of the GWAS summary statistic</td>
</tr>
<tr>
<td align="center">target</td>
<td align="center">EUR.QC</td>
<td align="left">Informs <code>PRSice</code> that the input genotype files should have a prefix of <code>EUR.QC</code></td>
</tr>
<tr>
<td align="center">binary-target</td>
<td align="center">F</td>
<td align="left">Indicate if the phenotype of interest is a binary trait. F for no</td>
</tr>
<tr>
<td align="center">pheno</td>
<td align="center">EUR.height</td>
<td align="left">Provide <code>PRSice</code> with the phenotype file</td>
</tr>
<tr>
<td align="center">cov</td>
<td align="center">EUR.covariate</td>
<td align="left">Provide <code>PRSice</code> with the covariate file</td>
</tr>
<tr>
<td align="center">base-maf</td>
<td align="center">MAF:0.05</td>
<td align="left">Filter out SNPs with MAF &lt; 0.05 in the GWAS summary statistics, using information in the <code>MAF</code> column</td>
</tr>
<tr>
<td align="center">base-info</td>
<td align="center">INFO:0.8</td>
<td align="left">Filter out SNPs with INFO &lt; 0.8 in the GWAS summary statistics, using information in the <code>INFO</code> column</td>
</tr>
<tr>
<td align="center">stat</td>
<td align="center">OR</td>
<td align="left">Column name of the column containing the effect size</td>
</tr>
<tr>
<td align="center">or</td>
<td align="center">-</td>
<td align="left">Inform <code>PRSice</code> that the effect size is an Odd Ratio</td>
</tr>
<tr>
<td align="center">out</td>
<td align="center">EUR</td>
<td align="left">Informs <code>PRSice</code> that all output should have a prefix of <code>EUR</code></td>
</tr>
</tbody>
</table>
<p>This will automatically perform "high-resolution scoring" and generate the "best-fit" PRS (in <strong>EUR.best</strong>), with associated plots of the results. 
Users should read Section 4.6 of our paper to learn more about issues relating to overfitting in PRS analyses.  </p>
<details class="note"><summary>Which P-value threshold generates the "best-fit" PRS?</summary><p>0.13995</p>
</details>
<details class="note"><summary>How much phenotypic variation does the "best-fit" PRS explain?</summary><p>0.166117</p>
</details>
<p><code>lassosum</code> is one of the dedicated PRS programs which is an <code>R</code> package that uses penalised regression (LASSO) in its approach to PRS calculation.</p>
<h2 id="installing-lassosum">Installing lassosum<a class="headerlink" href="#installing-lassosum" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The script used here is based on lassosum version 0.4.4</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For more details, please refer to <a href="https://github.com/tshmak/lassosum/">lassosum's homepage</a></p>
</div>
<p>You can install <code>lassosum</code> and its dependencies in <code>R</code> with the following command:</p>
<pre class="highlight"><code class="language-R">install.packages(c("devtools","RcppArmadillo", "data.table", "Matrix"), dependencies=TRUE)
library(devtools)
install_github("tshmak/lassosum")</code></pre>
<h2 id="required-data_1">Required Data<a class="headerlink" href="#required-data_1" title="Permanent link">&para;</a></h2>
<p>Again, we assume that we have the following files (or you can download it from <a href="https://drive.google.com/file/d/1x_G0Gxk9jFMY-PMqwtg6-vdEyUPp5p5u/view?usp=sharing">here</a>): </p>
<table>
<thead>
<tr>
<th align="center">File Name</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><strong>Height.QC.gz</strong></td>
<td align="center">The post-QCed summary statistic</td>
</tr>
<tr>
<td align="center"><strong>EUR.QC.bed</strong></td>
<td align="center">The genotype file after performing some basic filtering</td>
</tr>
<tr>
<td align="center"><strong>EUR.QC.bim</strong></td>
<td align="center">This file contains the SNPs that passed the basic filtering</td>
</tr>
<tr>
<td align="center"><strong>EUR.QC.fam</strong></td>
<td align="center">This file contains the samples that passed the basic filtering</td>
</tr>
<tr>
<td align="center"><strong>EUR.height</strong></td>
<td align="center">This file contains the phenotype of the samples</td>
</tr>
<tr>
<td align="center"><strong>EUR.cov</strong></td>
<td align="center">This file contains the covariates of the samples</td>
</tr>
<tr>
<td align="center"><strong>EUR.eigenvec</strong></td>
<td align="center">This file contains the PCs of the samples</td>
</tr>
</tbody>
</table>
<h2 id="running-prs-analysis_1">Running PRS analysis<a class="headerlink" href="#running-prs-analysis_1" title="Permanent link">&para;</a></h2>
<p>We can run lassosum as follows: </p>
<pre class="highlight"><code class="language-R">library(lassosum)
# Prefer to work with data.table as it speeds up file reading
library(data.table)
library(methods)
library(magrittr)
# For multi-threading, you can use the parallel package and 
# invoke cl which is then passed to lassosum.pipeline
library(parallel)
# This will invoke 2 threads. 
cl &lt;- makeCluster(2)

sum.stat &lt;- "Height.QC.gz"
bfile &lt;- "EUR.QC"
# Read in and process the covariates
covariate &lt;- fread("EUR.cov")
pcs &lt;- fread("EUR.eigenvec") %&gt;%
    setnames(., colnames(.), c("FID","IID", paste0("PC",1:6)))
# Need as.data.frame here as lassosum doesn't handle data.table 
# covariates very well
cov &lt;- merge(covariate, pcs)

# We will need the EUR.hg19 file provided by lassosum 
# which are LD regions defined in Berisa and Pickrell (2015) for the European population and the hg19 genome.
ld.file &lt;- "EUR.hg19"
# output prefix
prefix &lt;- "EUR"
# Read in the target phenotype file
target.pheno &lt;- fread("EUR.height")[,c("FID", "IID", "Height")]
# Read in the summary statistics
ss &lt;- fread(sum.stat)
# Remove P-value = 0, which causes problem in the transformation
ss &lt;- ss[!P == 0]
# Transform the P-values into correlation
cor &lt;- p2cor(p = ss$P,
        n = ss$N,
        sign = log(ss$OR)
        )
fam &lt;- fread(paste0(bfile, ".fam"))
fam[,ID:=do.call(paste, c(.SD, sep=":")),.SDcols=c(1:2)]


# Run the lassosum pipeline
# The cluster parameter is used for multi-threading
# You can ignore that if you do not wish to perform multi-threaded processing
out &lt;- lassosum.pipeline(
    cor = cor,
    chr = ss$CHR,
    pos = ss$BP,
    A1 = ss$A1,
    A2 = ss$A2,
    ref.bfile = bfile,
    test.bfile = bfile,
    LDblocks = ld.file, 
    cluster=cl
)
# Store the R2 results
target.res &lt;- validate(out, pheno = target.pheno, covar=cov)
# Get the maximum R2
r2 &lt;- max(target.res$validation.table$value)^2</code></pre>
<details class="note"><summary>How much phenotypic variation does the "best-fit" PRS explain?</summary><p>0.2395471</p>
</details>
<h2 id="sample-size"># Sample size<a class="headerlink" href="#sample-size" title="Permanent link">&para;</a></h2>
<p>We recommend that users only perform PRS analyses on target data of at least 100 individuals. The sample size of our target data here is 503 individuals. </p>
<h2 id="file-transfer"># File transfer<a class="headerlink" href="#file-transfer" title="Permanent link">&para;</a></h2>
<p>Usually we do not need to download and transfer the target data file because it is typically generated locally. However, the file should contain an md5sum code in case we send the data file to collaborators who may want to confirm that the file has not changed during the transfer.</p>
<details class="note"><summary>What is the md5sum code for each of the target files?</summary><table>
<thead>
<tr>
<th align="center">File</th>
<th align="center">md5sum</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><strong>EUR.bed</strong></td>
<td align="center">98bcef133f683b1272d3ea5f97742e0e</td>
</tr>
<tr>
<td align="center"><strong>EUR.bim</strong></td>
<td align="center">6b286002904880055a9c94e01522f059</td>
</tr>
<tr>
<td align="center"><strong>EUR.cov</strong></td>
<td align="center">85ed18288c708e095385418517e9c3bd</td>
</tr>
<tr>
<td align="center"><strong>EUR.fam</strong></td>
<td align="center">e7b856f0c7bcaffc8405926d08386e97</td>
</tr>
<tr>
<td align="center"><strong>EUR.height</strong></td>
<td align="center">dd445ce969a81cded20da5c88b82d4df</td>
</tr>
</tbody>
</table>
</details>
<h2 id="genome-build"># Genome build<a class="headerlink" href="#genome-build" title="Permanent link">&para;</a></h2>
<p>As stated in the base data section, the genome build for our base and target data is the same, as it should be.</p>
<h2 id="standard-gwas-qc"># Standard GWAS QC<a class="headerlink" href="#standard-gwas-qc" title="Permanent link">&para;</a></h2>
<p>The target data must be quality controlled to at least the standards 
implemented in GWAS studies, e.g. removing SNPs with low genotyping rate, 
low minor allele frequency, out of Hardy-Weinberg Equilibrium, removing
individuals with low genotyping rate 
(see <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6001694/">Marees et al</a>).</p>
<p>The following <code>plink</code> command applies some of these QC metrics to the target data:</p>
<pre class="highlight"><code class="language-bash">plink \
    --bfile EUR \
    --maf 0.01 \
    --hwe 1e-6 \
    --geno 0.01 \
    --mind 0.01 \
    --write-snplist \
    --make-just-fam \
    --out EUR.QC</code></pre>
<p>Each of the parameters corresponds to the following</p>
<table>
<thead>
<tr>
<th align="center">Paramter</th>
<th align="center">Value</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">bfile</td>
<td align="center">EUR</td>
<td align="left">Informs <code>plink</code> that the input genotype files should have a prefix of <code>EUR</code></td>
</tr>
<tr>
<td align="center">maf</td>
<td align="center">0.01</td>
<td align="left">Removes all SNPs with minor allele frequency less than 0.05. Genotyping errors typically have a larger influence on SNPs with low MAF. Studies with large sample sizes could apply a lower MAF threshold</td>
</tr>
<tr>
<td align="center">hwe</td>
<td align="center">1e-6</td>
<td align="left">Removes SNPs with low P-value from the Hardy-Weinberg Equilibrium Fisher's exact or chi-squared test. SNPs with significant P-values from the HWE test are more likely affected by genotyping error or the effects of natural selection. Filtering should be performed on the control samples to avoid filtering SNPs that are causal (under selection in cases). When phenotype information is included, plink will automatically perform the filtering in the controls.</td>
</tr>
<tr>
<td align="center">geno</td>
<td align="center">0.01</td>
<td align="left">Excludes SNPs that are missing in a high fraction of subjects. A two-stage filtering process is usually performed (see <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6001694/">Marees et al</a>).</td>
</tr>
<tr>
<td align="center">mind</td>
<td align="center">0.01</td>
<td align="left">Excludes individuals who have a high rate of genotype missingness, since this may indicate problems in the DNA sample or processing. (see <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6001694/">Marees et al</a> for more details).</td>
</tr>
<tr>
<td align="center">make-just-fam</td>
<td align="center">-</td>
<td align="left">Informs <code>plink</code> to only generate the QC'ed sample name to avoid generating the .bed file.</td>
</tr>
<tr>
<td align="center">write-snplist</td>
<td align="center">-</td>
<td align="left">Informs <code>plink</code> to only generate the QC'ed SNP list to avoid generating the .bed file.</td>
</tr>
<tr>
<td align="center">out</td>
<td align="center">EUR.QC</td>
<td align="left">Informs <code>plink</code> that all output should have a prefix of <code>EUR.QC</code></td>
</tr>
</tbody>
</table>
<details class="note"><summary>How many SNPs and samples were filtered?</summary><ul>
<li><code>14</code> samples were removed due to a high rate of genotype missingness</li>
<li><code>5,353</code> SNP were removed due to missing genotype data</li>
<li><code>944</code> SNPs were removed due to being out of Hardy-Weinberg Equilibrium</li>
<li><code>5,061</code> SNPs were removed due to low minor allele frequency</li>
</ul>
</details>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Normally, we can generate a new genotype file using the new sample list.
However,  this will use up a lot of storage space. Using <code>plink</code>'s
<code>--extract</code>, <code>--exclude</code>, <code>--keep</code>, <code>--remove</code>, <code>--make-just-fam</code> and <code>--write-snplist</code> functions, we can work 
solely on the list of samples and SNPs without duplicating the 
genotype file, reducing the storage space usage.  </p>
</div>
<p>Very high or low heterozygosity rates in individuals could be due to DNA contamination or to high levels of inbreeding. Therefore, samples with extreme heterozygosity are typically removed prior to downstream analyses. </p>
<p>First, we perform prunning to remove highly correlated SNPs:</p>
<pre class="highlight"><code class="language-bash">plink \
    --bfile EUR \
    --keep EUR.QC.fam \
    --extract EUR.QC.snplist \
    --indep-pairwise 200 50 0.25 \
    --out EUR.QC</code></pre>
<p>Each of the parameters corresponds to the following</p>
<table>
<thead>
<tr>
<th align="center">Paramter</th>
<th align="center">Value</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">bfile</td>
<td align="center">EUR</td>
<td align="left">Informs <code>plink</code> that the input genotype files should have a prefix of <code>EUR</code></td>
</tr>
<tr>
<td align="center">keep</td>
<td align="center">EUR.QC.fam</td>
<td align="left">Informs <code>plink</code> that we only want to use samples in <code>EUR.QC.fam</code> in the analysis</td>
</tr>
<tr>
<td align="center">extract</td>
<td align="center">EUR.QC.snplist</td>
<td align="left">Informs <code>plink</code> that we only want to use SNPs in <code>EUR.QC.snplist</code> in the analysis</td>
</tr>
<tr>
<td align="center">indep-pairwise</td>
<td align="center">200 50 0.25</td>
<td align="left">Informs <code>plink</code> that we wish to perform prunning with a window size of 200 variants, sliding across the genome with step size of 50 variants at a time, and filter out any SNPs with LD <span class="arithmatex">\(r^2\)</span> higher than 0.25</td>
</tr>
<tr>
<td align="center">out</td>
<td align="center">EUR.QC</td>
<td align="left">Informs <code>plink</code> that all output should have a prefix of <code>EUR.QC</code></td>
</tr>
</tbody>
</table>
<p>This will generate two files 1) <strong>EUR.QC.prune.in</strong> and 2) <strong>EUR.QC.prune.out</strong>. All SNPs within <strong>EUR.QC.prune.in</strong> have a pairwise <span class="arithmatex">\(r^2 &lt; 0.25\)</span>. </p>
<p>Heterozygosity rates can then be computed using <code>plink</code>:</p>
<pre class="highlight"><code class="language-bash">plink \
    --bfile EUR \
    --extract EUR.QC.prune.in \
    --keep EUR.QC.fam \
    --het \
    --out EUR.QC</code></pre>
<p>This will generate the <strong>EUR.QC.het</strong> file, which contains F coefficient estimates for assessing heterozygosity.
We will remove individuals with F coefficients that are more than 3 standard deviation (SD) units from the mean, which can be performed using the following <code>R</code> command (assuming that you have R downloaded, then you can open an <code>R</code> session by typing <code>R</code> in your terminal):</p>
<div class="tabbed-set" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><label for="__tabbed_3_1">Without library</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">dat &lt;- read.table("EUR.QC.het", header=T) # Read in the EUR.het file, specify it has header
m &lt;- mean(dat$F) # Calculate the mean  
s &lt;- sd(dat$F) # Calculate the SD
valid &lt;- subset(dat, F &lt;= m+3*s &amp; F &gt;= m-3*s) # Get any samples with F coefficient within 3 SD of the population mean
write.table(valid[,c(1,2)], "EUR.valid.sample", quote=F, row.names=F) # print FID and IID for valid samples
q() # exit R</code></pre>
</div>
<input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><label for="__tabbed_3_2">With data.table</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">library(data.table)
# Read in file
dat &lt;- fread("EUR.QC.het")
# Get samples with F coefficient within 3 SD of the population mean
valid &lt;- dat[F&lt;=mean(F)+3*sd(F) &amp; F&gt;=mean(F)-3*sd(F)] 
# print FID and IID for valid samples
fwrite(valid[,c("FID","IID")], "EUR.valid.sample", sep="\t") 
q() # exit R</code></pre>
</div>
</div>
<details class="note"><summary>How many samples were excluded due to high heterozygosity rate?</summary><ul>
<li><code>2</code> samples were excluded</li>
</ul>
</details>
<h2 id="ambiguous-snps"># Ambiguous SNPs<a class="headerlink" href="#ambiguous-snps" title="Permanent link">&para;</a></h2>
<p>These were removed during the base data QC.</p>
<h2 id="mismatching-snps"># Mismatching SNPs<a class="headerlink" href="#mismatching-snps" title="Permanent link">&para;</a></h2>
<p>SNPs that have mismatching alleles reported in the base and target data may be resolvable by strand-flipping the alleles to their complementary alleles in e.g. the target data, such as for a SNP with A/C in the base data and G/T in the target. This can be achieved with the following steps:</p>
<p>1. Load the bim file, the summary statistic and the QC SNP list into R</p>
<div class="tabbed-set" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><label for="__tabbed_4_1">Without data.table</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R"># Read in bim file
bim &lt;- read.table("EUR.bim")
colnames(bim) &lt;- c("CHR", "SNP", "CM", "BP", "B.A1", "B.A2")
# Read in QCed SNPs
qc &lt;- read.table("EUR.QC.snplist", header = F, stringsAsFactors = F)
# Read in the GWAS data
height &lt;-
    read.table(gzfile("Height.QC.gz"),
            header = T,
            stringsAsFactors = F, 
            sep="\t")
# Change all alleles to upper case for easy comparison
height$A1 &lt;- toupper(height$A1)
height$A2 &lt;- toupper(height$A2)
bim$B.A1 &lt;- toupper(bim$B.A1)
bim$B.A2 &lt;- toupper(bim$B.A2)</code></pre>
</div>
<input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><label for="__tabbed_4_2">With data.table and magrittr</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R"># magrittr allow us to do piping, which help to reduce the 
# amount of intermediate data types
library(data.table)
library(magrittr)
# Read in bim file 
bim &lt;- fread("EUR.bim") %&gt;%
    # Note: . represents the output from previous step
    # The syntax here means, setnames of the data read from
    # the bim file, and replace the original column names by 
    # the new names
    setnames(., colnames(.), c("CHR", "SNP", "CM", "BP", "B.A1", "B.A2")) %&gt;%
    # And immediately change the alleles to upper cases
    .[,c("B.A1","B.A2"):=list(toupper(B.A1), toupper(B.A2))]
# Read in summary statistic data (require data.table v1.12.0+)
height &lt;- fread("Height.QC.gz") %&gt;%
    # And immediately change the alleles to upper cases
    .[,c("A1","A2"):=list(toupper(A1), toupper(A2))]
# Read in QCed SNPs
qc &lt;- fread("EUR.QC.snplist", header=F)</code></pre>
</div>
</div>
<p>2. Identify SNPs that require strand flipping </p>
<div class="tabbed-set" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><label for="__tabbed_5_1">Without data.table</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R"># Merge summary statistic with target
info &lt;- merge(bim, height, by = c("SNP", "CHR", "BP"))
# Filter QCed SNPs
info &lt;- info[info$SNP %in% qc$V1,]
# Function for finding the complementary allele
complement &lt;- function(x) {
    switch (
        x,
        "A" = "T",
        "C" = "G",
        "T" = "A",
        "G" = "C",
        return(NA)
    )
}
# Get SNPs that have the same alleles across base and target
info.match &lt;- subset(info, A1 == B.A1 &amp; A2 == B.A2)
# Identify SNPs that are complementary between base and target
info$C.A1 &lt;- sapply(info$B.A1, complement)
info$C.A2 &lt;- sapply(info$B.A2, complement)
info.complement &lt;- subset(info, A1 == C.A1 &amp; A2 == C.A2)
# Update the complementary alleles in the bim file
# This allow us to match the allele in subsequent analysis
complement.snps &lt;- bim$SNP %in% info.complement$SNP
bim[complement.snps,]$B.A1 &lt;-
    sapply(bim[complement.snps,]$B.A1, complement)
bim[complement.snps,]$B.A2 &lt;-
    sapply(bim[complement.snps,]$B.A2, complement)</code></pre>
</div>
<input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><label for="__tabbed_5_2">With data.table and magrittr</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R"># Merge summary statistic with target
info &lt;- merge(bim, height, by=c("SNP", "CHR", "BP")) %&gt;%
    # And filter out QCed SNPs
    .[SNP %in% qc[,V1]]

# Function for calculating the complementary allele
complement &lt;- function(x){
    switch (x,
        "A" = "T",
        "C" = "G",
        "T" = "A",
        "G" = "C",
        return(NA)
    )
} 
# Get SNPs that have the same alleles across base and target
info.match &lt;- info[A1 == B.A1 &amp; A2 == B.A2, SNP]
# Identify SNPs that are complementary between base and target
com.snps &lt;- info[sapply(B.A1, complement) == A1 &amp;
                    sapply(B.A2, complement) == A2, SNP]
# Now update the bim file
bim[SNP %in% com.snps, c("B.A1", "B.A2") :=
        list(sapply(B.A1, complement),
            sapply(B.A2, complement))]</code></pre>
</div>
</div>
<p>3. Identify SNPs that require recoding in the target (to ensure the coding allele in the target data is the effective allele in the base summary statistic)</p>
<p>We assume that you have the following files (or you can download it from <a href="https://drive.google.com/file/d/1x_G0Gxk9jFMY-PMqwtg6-vdEyUPp5p5u/view?usp=sharing">here</a>):</p>
<table>
<thead>
<tr>
<th align="center">File Name</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><strong>Height.QC.gz</strong></td>
<td align="center">The post-QCed summary statistic</td>
</tr>
<tr>
<td align="center"><strong>EUR.QC.bed</strong></td>
<td align="center">The genotype file after performing some basic filtering</td>
</tr>
<tr>
<td align="center"><strong>EUR.QC.bim</strong></td>
<td align="center">This file contains the SNPs that passed the basic filtering</td>
</tr>
<tr>
<td align="center"><strong>EUR.QC.fam</strong></td>
<td align="center">This file contains the samples that passed the basic filtering</td>
</tr>
<tr>
<td align="center"><strong>EUR.height</strong></td>
<td align="center">This file contains the phenotype of the samples</td>
</tr>
<tr>
<td align="center"><strong>EUR.cov</strong></td>
<td align="center">This file contains the covariates of the samples</td>
</tr>
<tr>
<td align="center"><strong>EUR.eigenvec</strong></td>
<td align="center">This file contains the PCs of the samples</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>While we do provide a rough guide on how to perform LDpred on bed files separated into individual chromosomes, this script is untested and extra caution is required</p>
</div>
<h3 id="0-prepare-workspace">0. Prepare workspace<a class="headerlink" href="#0-prepare-workspace" title="Permanent link">&para;</a></h3>
<p>On some server, you might need to first use the following code in order to run LDpred with multi-thread</p>
<div class="tabbed-set" data-tabs="6:1"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><label for="__tabbed_6_1">prepare workspace and load bigsnpr</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">library(bigsnpr)
options(bigstatsr.check.parallel.blas = FALSE)
options(default.nproc.blas = NULL)</code></pre>
</div>
</div>
<h3 id="1-read-in-the-phenotype-and-covariate-files">1. Read in the phenotype and covariate files<a class="headerlink" href="#1-read-in-the-phenotype-and-covariate-files" title="Permanent link">&para;</a></h3>
<div class="tabbed-set" data-tabs="7:1"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><label for="__tabbed_7_1">read in phenotype and covariates</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">library(data.table)
library(magrittr)
phenotype &lt;- fread("EUR.height")
covariate &lt;- fread("EUR.cov")
pcs &lt;- fread("EUR.eigenvec")
# rename columns
colnames(pcs) &lt;- c("FID","IID", paste0("PC",1:6))
# generate required table
pheno &lt;- merge(phenotype, covariate) %&gt;%
    merge(., pcs)</code></pre>
</div>
</div>
<h3 id="2-obtain-hapmap3-snps">2. Obtain HapMap3 SNPs<a class="headerlink" href="#2-obtain-hapmap3-snps" title="Permanent link">&para;</a></h3>
<p>LDpred2 authors recommend restricting the analysis to only the HapMap3 SNPs</p>
<div class="tabbed-set" data-tabs="8:1"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><label for="__tabbed_8_1">load HapMap3 SNPs</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">info &lt;- readRDS(url("https://github.com/privefl/bigsnpr/raw/master/data-raw/hm3_variants.rds"))</code></pre>
</div>
</div>
<h3 id="3-load-and-transform-the-summary-statistic-file">3. Load and transform the summary statistic file<a class="headerlink" href="#3-load-and-transform-the-summary-statistic-file" title="Permanent link">&para;</a></h3>
<div class="tabbed-set" data-tabs="9:1"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><label for="__tabbed_9_1">Load summary statistic file</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R"># Read in the summary statistic file
sumstats &lt;- bigreadr::fread2("Height.QC.gz") 
# LDpred 2 require the header to follow the exact naming
names(sumstats) &lt;-
    c("chr",
    "pos",
    "rsid",
    "a1",
    "a0",
    "n_eff",
    "beta_se",
    "p",
    "OR",
    "INFO",
    "MAF")
# Transform the OR into log(OR)
sumstats$beta &lt;- log(sumstats$OR)
# Filter out hapmap SNPs
sumstats &lt;- sumstats[sumstats$rsid%in% info$rsid,]</code></pre>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Here, we know the exact ordering of the summary statistics file. 
However, in many cases, the ordering of the summary statistics differ, 
thus one must rename the columns according to their actual ordering</p>
</div>
</div>
</div>
<h3 id="3-calculate-the-ld-matrix">3. Calculate the LD matrix<a class="headerlink" href="#3-calculate-the-ld-matrix" title="Permanent link">&para;</a></h3>
<div class="tabbed-set" data-tabs="10:2"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><label for="__tabbed_10_1">Genome Wide bed file</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R"># Get maximum amount of cores
NCORES &lt;- nb_cores()
# Open a temporary file
tmp &lt;- tempfile(tmpdir = "tmp-data")
on.exit(file.remove(paste0(tmp, ".sbk")), add = TRUE)
# Initialize variables for storing the LD score and LD matrix
corr &lt;- NULL
ld &lt;- NULL
# We want to know the ordering of samples in the bed file 
fam.order &lt;- NULL
# preprocess the bed file (only need to do once for each data set)
snp_readBed("EUR.QC.bed")
# now attach the genotype object
obj.bigSNP &lt;- snp_attach("EUR.QC.rds")
# extract the SNP information from the genotype
map &lt;- obj.bigSNP$map[-3]
names(map) &lt;- c("chr", "rsid", "pos", "a1", "a0")
# perform SNP matching
info_snp &lt;- snp_match(sumstats, map)
# Assign the genotype to a variable for easier downstream analysis
genotype &lt;- obj.bigSNP$genotypes
# Rename the data structures
CHR &lt;- map$chr
POS &lt;- map$pos
# get the CM information from 1000 Genome
# will download the 1000G file to the current directory (".")
POS2 &lt;- snp_asGeneticPos(CHR, POS, dir = ".")
# calculate LD
for (chr in 1:22) {
    # Extract SNPs that are included in the chromosome
    ind.chr &lt;- which(info_snp$chr == chr)
    ind.chr2 &lt;- info_snp$`_NUM_ID_`[ind.chr]
    # Calculate the LD
    corr0 &lt;- snp_cor(
            genotype,
            ind.col = ind.chr2,
            ncores = NCORES,
            infos.pos = POS2[ind.chr2],
            size = 3 / 1000
        )
    if (chr == 1) {
        ld &lt;- Matrix::colSums(corr0^2)
        corr &lt;- as_SFBM(corr0, tmp)
    } else {
        ld &lt;- c(ld, Matrix::colSums(corr0^2))
        corr$add_columns(corr0, nrow(corr))
    }
}
# We assume the fam order is the same across different chromosomes
fam.order &lt;- as.data.table(obj.bigSNP$fam)
# Rename fam order
setnames(fam.order,
        c("family.ID", "sample.ID"),
        c("FID", "IID"))</code></pre>
</div>
<input id="__tabbed_10_2" name="__tabbed_10" type="radio" /><label for="__tabbed_10_2">Chromosome separated bed files</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R"># Get maximum amount of cores
NCORES &lt;- nb_cores()
# Open a temporary file
tmp &lt;- tempfile(tmpdir = "tmp-data")
on.exit(file.remove(paste0(tmp, ".sbk")), add = TRUE)
# Initialize variables for storing the LD score and LD matrix
corr &lt;- NULL
ld &lt;- NULL
# We want to know the ordering of samples in the bed file 
info_snp &lt;- NULL
fam.order &lt;- NULL
for (chr in 1:22) {
    # preprocess the bed file (only need to do once for each data set)
    # Assuming the file naming is EUR_chr#.bed
    snp_readBed(paste0("EUR_chr",chr,".bed"))
    # now attach the genotype object
    obj.bigSNP &lt;- snp_attach(paste0("EUR_chr",chr,".rds"))
    # extract the SNP information from the genotype
    map &lt;- obj.bigSNP$map[-3]
    names(map) &lt;- c("chr", "rsid", "pos", "a1", "a0")
    # perform SNP matching
    tmp_snp &lt;- snp_match(sumstats[sumstats$chr==chr,], map)
    info_snp &lt;- rbind(info_snp, tmp_snp)
    # Assign the genotype to a variable for easier downstream analysis
    genotype &lt;- obj.bigSNP$genotypes
    # Rename the data structures
    CHR &lt;- map$chr
    POS &lt;- map$pos
    # get the CM information from 1000 Genome
    # will download the 1000G file to the current directory (".")
    POS2 &lt;- snp_asGeneticPos(CHR, POS, dir = ".")
    # calculate LD
    # Extract SNPs that are included in the chromosome
    ind.chr &lt;- which(tmp_snp$chr == chr)
    ind.chr2 &lt;- tmp_snp$`_NUM_ID_`[ind.chr]
    # Calculate the LD
    corr0 &lt;- snp_cor(
            genotype,
            ind.col = ind.chr2,
            ncores = NCORES,
            infos.pos = POS2[ind.chr2],
            size = 3 / 1000
        )
    if (chr == 1) {
        ld &lt;- Matrix::colSums(corr0^2)
        corr &lt;- as_SFBM(corr0, tmp)
    } else {
        ld &lt;- c(ld, Matrix::colSums(corr0^2))
        corr$add_columns(corr0, nrow(corr))
    }
    # We assume the fam order is the same across different chromosomes
    if(is.null(fam.order)){
        fam.order &lt;- as.data.table(obj.bigSNP$fam)
    }
}
# Rename fam order
setnames(fam.order,
        c("family.ID", "sample.ID"),
        c("FID", "IID"))</code></pre>
</div>
</div>
<h3 id="4-perform-ld-score-regression">4. Perform LD score regression<a class="headerlink" href="#4-perform-ld-score-regression" title="Permanent link">&para;</a></h3>
<div class="tabbed-set" data-tabs="11:1"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><label for="__tabbed_11_1">Perform LD score regression</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">df_beta &lt;- info_snp[,c("beta", "beta_se", "n_eff", "_NUM_ID_")]
ldsc &lt;- snp_ldsc(   ld, 
                    length(ld), 
                    chi2 = (df_beta$beta / df_beta$beta_se)^2,
                    sample_size = df_beta$n_eff, 
                    blocks = NULL)
h2_est &lt;- ldsc[["h2"]]</code></pre>
</div>
</div>
<h3 id="5-calculate-the-null-r2">5. Calculate the null R2<a class="headerlink" href="#5-calculate-the-null-r2" title="Permanent link">&para;</a></h3>
<div class="tabbed-set" data-tabs="12:2"><input checked="checked" id="__tabbed_12_1" name="__tabbed_12" type="radio" /><label for="__tabbed_12_1">Calculate the null R2 (quantitative trait)</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R"># Reformat the phenotype file such that y is of the same order as the 
# sample ordering in the genotype file
y &lt;- pheno[fam.order, on = c("FID", "IID")]
# Calculate the null R2
# use glm for binary trait 
# (will also need the fmsb package to calculate the pseudo R2)
null.model &lt;- paste("PC", 1:6, sep = "", collapse = "+") %&gt;%
    paste0("Height~Sex+", .) %&gt;%
    as.formula %&gt;%
    lm(., data = y) %&gt;%
    summary
null.r2 &lt;- null.model$r.squared</code></pre>
</div>
<input id="__tabbed_12_2" name="__tabbed_12" type="radio" /><label for="__tabbed_12_2">Calculate the null R2 (binary trait)</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">library(fmsb)
# Reformat the phenotype file such that y is of the same order as the 
# sample ordering in the genotype file
y &lt;- pheno[fam.order, on = c("FID", "IID")]
# Calculate the null R2
# use glm for binary trait 
# (will also need the fmsb package to calculate the pseudo R2)
null.model &lt;- paste("PC", 1:6, sep = "", collapse = "+") %&gt;%
    paste0("Height~Sex+", .) %&gt;%
    as.formula %&gt;%
    glm(., data = y, family=binomial) %&gt;%
    summary
null.r2 &lt;- fmsb::NagelkerkeR2(null.model)</code></pre>
</div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Scripts for binary trait analysis only serve as a reference as we have not simulate any binary traits. 
In addition, Nagelkerke <span class="arithmatex">\(R^2\)</span> is biased when there are ascertainment of samples. For more information, please refer to <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/gepi.21614">this paper</a></p>
</div>
<div class="tabbed-set" data-tabs="13:3"><input checked="checked" id="__tabbed_13_1" name="__tabbed_13" type="radio" /><label for="__tabbed_13_1">infinitesimal model</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">beta_inf &lt;- snp_ldpred2_inf(corr, df_beta, h2 = h2_est)</code></pre>
</div>
<input id="__tabbed_13_2" name="__tabbed_13" type="radio" /><label for="__tabbed_13_2">grid model</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R"># Prepare data for grid model
p_seq &lt;- signif(seq_log(1e-4, 1, length.out = 17), 2)
h2_seq &lt;- round(h2_est * c(0.7, 1, 1.4), 4)
grid.param &lt;-
    expand.grid(p = p_seq,
            h2 = h2_seq,
            sparse = c(FALSE, TRUE))
# Get adjusted beta from grid model
beta_grid &lt;-
    snp_ldpred2_grid(corr, df_beta, grid.param, ncores = NCORES)</code></pre>
</div>
<input id="__tabbed_13_3" name="__tabbed_13" type="radio" /><label for="__tabbed_13_3">auto model</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R"># Get adjusted beta from the auto model
multi_auto &lt;- snp_ldpred2_auto(
    corr,
    df_beta,
    h2_init = h2_est,
    vec_p_init = seq_log(1e-4, 0.9, length.out = NCORES),
    ncores = NCORES
)
beta_auto &lt;- sapply(multi_auto, function(auto)
    auto$beta_est)</code></pre>
</div>
</div>
<h3 id="7-obtain-model-prs">7. Obtain model PRS<a class="headerlink" href="#7-obtain-model-prs" title="Permanent link">&para;</a></h3>
<h4 id="using-genome-wide-bed-file">Using Genome wide bed file<a class="headerlink" href="#using-genome-wide-bed-file" title="Permanent link">&para;</a></h4>
<div class="tabbed-set" data-tabs="14:3"><input checked="checked" id="__tabbed_14_1" name="__tabbed_14" type="radio" /><label for="__tabbed_14_1">infinitesimal model</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">if(is.null(obj.bigSNP)){
    obj.bigSNP &lt;- snp_attach("EUR.QC.rds")
}
genotype &lt;- obj.bigSNP$genotypes
# calculate PRS for all samples
ind.test &lt;- 1:nrow(genotype)
pred_inf &lt;- big_prodVec(    genotype,
                            beta_inf,
                            ind.row = ind.test,
                            ind.col = info_snp$`_NUM_ID_`)</code></pre>
</div>
<input id="__tabbed_14_2" name="__tabbed_14" type="radio" /><label for="__tabbed_14_2">grid model</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">if(is.null(obj.bigSNP)){
    obj.bigSNP &lt;- snp_attach("EUR.QC.rds")
}
genotype &lt;- obj.bigSNP$genotypes
# calculate PRS for all samples
ind.test &lt;- 1:nrow(genotype)
pred_grid &lt;- big_prodMat(   genotype, 
                            beta_grid, 
                            ind.col = info_snp$`_NUM_ID_`)</code></pre>
</div>
<input id="__tabbed_14_3" name="__tabbed_14" type="radio" /><label for="__tabbed_14_3">auto model</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">if(is.null(obj.bigSNP)){
    obj.bigSNP &lt;- snp_attach("EUR.QC.rds")
}
genotype &lt;- obj.bigSNP$genotypes
# calculate PRS for all samples
ind.test &lt;- 1:nrow(genotype)
pred_auto &lt;-
    big_prodMat(genotype,
                beta_auto,
                ind.row = ind.test,
                ind.col = info_snp$`_NUM_ID_`)
# scale the PRS generated from AUTO
pred_scaled &lt;- apply(pred_auto, 2, sd)
final_beta_auto &lt;-
    rowMeans(beta_auto[,
                abs(pred_scaled -
                    median(pred_scaled)) &lt;
                    3 * mad(pred_scaled)])
pred_auto &lt;-
    big_prodVec(genotype,
        final_beta_auto,
        ind.row = ind.test,
        ind.col = info_snp$`_NUM_ID_`)</code></pre>
</div>
</div>
<h4 id="using-chromosome-separated-bed-files">Using chromosome separated bed files<a class="headerlink" href="#using-chromosome-separated-bed-files" title="Permanent link">&para;</a></h4>
<div class="tabbed-set" data-tabs="15:3"><input checked="checked" id="__tabbed_15_1" name="__tabbed_15" type="radio" /><label for="__tabbed_15_1">infinitesimal model</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">pred_inf &lt;- NULL
for(chr in 1:22){
    obj.bigSNP &lt;- snp_attach(paste0("EUR_chr",chr,".rds"))
    genotype &lt;- obj.bigSNP$genotypes
    # calculate PRS for all samples
    ind.test &lt;- 1:nrow(genotype)
    # Extract SNPs in this chromosome
    chr.idx &lt;- which(info_snp$chr == chr)
    ind.chr &lt;- info_snp$`_NUM_ID_`[chr.idx]
    tmp &lt;- big_prodVec(genotype,
                            beta_inf[chr.idx],
                            ind.row = ind.test,
                            ind.col = ind.chr)
    if(is.null(pred_inf)){
        pred_inf &lt;- tmp
    }else{
        pred_inf &lt;- pred_inf + tmp
    }
}</code></pre>
</div>
<input id="__tabbed_15_2" name="__tabbed_15" type="radio" /><label for="__tabbed_15_2">grid model</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">pred_grid &lt;- NULL
for(chr in 1:22){
    obj.bigSNP &lt;- snp_attach(paste0("EUR_chr",chr,"_.rds"))
    genotype &lt;- obj.bigSNP$genotypes
    # calculate PRS for all samples
    ind.test &lt;- 1:nrow(genotype)
    # Extract SNPs in this chromosome
    chr.idx &lt;- which(info_snp$chr == chr)
    ind.chr &lt;- info_snp$`_NUM_ID_`[chr.idx]

    tmp &lt;- big_prodMat( genotype, 
                        beta_grid[chr.idx], 
                        ind.col = ind.chr)

    if(is.null(pred_grid)){
        pred_grid &lt;- tmp
    }else{
        pred_grid &lt;- pred_grid + tmp
    }
}</code></pre>
</div>
<input id="__tabbed_15_3" name="__tabbed_15" type="radio" /><label for="__tabbed_15_3">auto model</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">pred_auto &lt;- NULL
for(chr in 1:22){
    obj.bigSNP &lt;- snp_attach(paste0("EUR_chr",chr,"_.rds"))
    genotype &lt;- obj.bigSNP$genotypes
    # calculate PRS for all samples
    ind.test &lt;- 1:nrow(genotype)
    # Extract SNPs in this chromosome
    chr.idx &lt;- which(info_snp$chr == chr)
    ind.chr &lt;- info_snp$`_NUM_ID_`[chr.idx]

    tmp &lt;-
        big_prodMat(genotype,
                    beta_auto[chr.idx],
                    ind.row = ind.test,
                    ind.col = ind.chr)
    # scale the PRS generated from AUTO
    pred_scaled &lt;- apply(tmp, 2, sd)
    final_beta_auto &lt;-
        rowMeans(beta_auto[chr.idx,
                    abs(pred_scaled -
                        median(pred_scaled)) &lt;
                        3 * mad(pred_scaled)])
    tmp &lt;-
        big_prodVec(genotype,
            final_beta_auto,
            ind.row = ind.test,
            ind.col = ind.chr)
    if(is.null(pred_auto)){
        pred_auto &lt;- tmp
    }else{
        pred_auto &lt;- pred_auto + tmp
    }
}</code></pre>
</div>
</div>
<h3 id="8-get-the-final-performance-of-the-ldpred-models">8. Get the final performance of the LDpred models<a class="headerlink" href="#8-get-the-final-performance-of-the-ldpred-models" title="Permanent link">&para;</a></h3>
<div class="tabbed-set" data-tabs="16:3"><input checked="checked" id="__tabbed_16_1" name="__tabbed_16" type="radio" /><label for="__tabbed_16_1">infinitesimal model</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">reg.formula &lt;- paste("PC", 1:6, sep = "", collapse = "+") %&gt;%
    paste0("Height~PRS+Sex+", .) %&gt;%
    as.formula
reg.dat &lt;- y
reg.dat$PRS &lt;- pred_inf
inf.model &lt;- lm(reg.formula, dat=reg.dat) %&gt;%
    summary
(result &lt;- data.table(
    infinitesimal = inf.model$r.squared - null.r2,
    null = null.r2
))</code></pre>
</div>
<input id="__tabbed_16_2" name="__tabbed_16" type="radio" /><label for="__tabbed_16_2">grid model</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">reg.formula &lt;- paste("PC", 1:6, sep = "", collapse = "+") %&gt;%
    paste0("Height~PRS+Sex+", .) %&gt;%
    as.formula
reg.dat &lt;- y
max.r2 &lt;- 0
for(i in 1:ncol(pred_grid)){
    reg.dat$PRS &lt;- pred_grid[,i]
    grid.model &lt;- lm(reg.formula, dat=reg.dat) %&gt;%
        summary  
    if(max.r2 &lt; grid.model$r.squared){
        max.r2 &lt;- grid.model$r.squared
    }
}
(result &lt;- data.table(
    grid = max.r2 - null.r2,
    null = null.r2
))</code></pre>
</div>
<input id="__tabbed_16_3" name="__tabbed_16" type="radio" /><label for="__tabbed_16_3">auto model</label><div class="tabbed-content">
<pre class="highlight"><code class="language-R">reg.formula &lt;- paste("PC", 1:6, sep = "", collapse = "+") %&gt;%
    paste0("Height~PRS+Sex+", .) %&gt;%
    as.formula
reg.dat &lt;- y
reg.dat$PRS &lt;- pred_auto
auto.model &lt;- lm(reg.formula, dat=reg.dat) %&gt;%
    summary
(result &lt;- data.table(
    auto = auto.model$r.squared - null.r2,
    null = null.r2
))</code></pre>
</div>
</div>
<details class="note"><summary>How much phenotypic variation does the PRS from each model explain?</summary><p>Infinitesimal = 0.0100</p>
<p>Grid Model = 0.00180</p>
<p>Auto Model = 0.171</p>
</details>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/choishingwan/PRS-Tutorial/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
      <script src="../javascripts/details.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
